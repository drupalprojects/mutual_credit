<?php

/**
 * @file
 * mcapi.module
 */

use Drupal\mcapi\Mcapi;
use Drupal\mcapi\Entity\Wallet;
use Drupal\Core\Url;
use Drupal\Core\Entity\ContentEntityInterface;


//@todo is it appropriate to use constants for plugin names?
const TRANSACTION_STATE_FINISHED = 'done';
const TRANSACTION_STATE_ERASED = 'erased';

/**
 * implements hook_requirements().
 */
function mcapi_requirements($phase) {
  if ($phase == 'runtime') {
    $result = [
      'title' => t('Transaction index table'),
    ];
    //check that the index table is integral
    if (\Drupal::entityTypeManager()->getStorage('mcapi_transaction')->indexCheck()) {
      $result['severity'] = REQUIREMENT_OK;
      $result['description'] = t('Index table adds up');
    }
    else {
      $result['severity'] = REQUIREMENT_ERROR;
      $result['description'] = t(
        'Index table does not add up. Try rebuilding it at %link',
        ['%link' => \Drupal::l('admin/accounting/misc', Url::fromRoute('mcapi.admin_misc'))]
      );
    }
    return array($result);
  }
}

/**
 * implements hook_help().
 */
function mcapi_help($route_name) {
  switch ($route_name) {
    case 'entity.mcapi_currency.collection':
      return implode(' ', [
        t('Multiple currencies allow many, potentially overlapping communities to work in this Drupal instance, and for currencies to embody different values.'),
        t('Retired currencies can no longer be used, but transactions are still visible.'),
        t('Only unused currencies can be deleted.'),
      ]);
    case 'mcapi.admin.workflow':
      $help = [
        t("Special 'actions' move transactions of various types between states, except for 'view', which is special"),
        t('More states and types can be added as custom module configuration entities; no user interface exists for that.'),
      ];
      if (\Drupal::moduleHandler()->moduleExists('field_ui')) {
        $help[] = t("N.B. 'Manage display' tab is hidden because transaction displays are all handled through configurable templates.");
      }
      return implode(' ', $help);
    case 'entity.mcapi_transaction.field_ui_fields':
      $settings_url = Url::fromRoute('mcapi.admin_misc');
      $action_url = Url::fromRoute('mcapi.admin.workflow');
      $message = [
        t('These transaction display settings should always be overridden.'),
        t('To configure the certificate, override certificate.html.twig in your theme'),
        t(
          'To configure the sentence, see the Accounting settings: %link.',
          ['%link' => \Drupal::l($settings_url->toString(), $settings_url)]
        ),
        t(
          'Custom Twig can be used for display on the action settings pages: %link.',
          ['%link' => \Drupal::l($action_url->toString(), $action_url)]
        ),
      ];
      return implode(' ', $message);
  }
}

/**
 * implements hook_entity_view().
 * add a wallet summary view to wallet-enabled entities
 *
 * @todo check the cache contexts because this contains a link to wallet creation.
 */
function mcapi_entity_view(array &$build, $entity, $display) {
  if ($display->getComponent('wallets_summaries')) {
    $wallets = [];
    foreach (Mcapi::walletsOf($entity, TRUE) as $wid => $wallet) {
      if ($wallet->access('view')) {
        $wallets[] = $wallet;
      }
    }
    if ($wallets) {
      $build += [
        'wallets_summaries' => \Drupal::entityTypeManager()
          ->getViewBuilder('mcapi_wallet')
          //the wallet 'summary' view mode is provided in this module's default config
          ->viewMultiple($wallets, 'summary'),
      ];
    }
  }
}

/**
 * implements hook_element_info_alter().
 * adds the 'balances' icon via css
 */
function mcapi_element_info_alter(&$items) {
  $items['toolbar']['#attached']['library'][] = 'mcapi/mcapi.toolbar';
}

/**
 * implements hook_entity_presave()
 * rename the entity's wallet in case the entity's name is changed
 */
function mcapi_entity_presave($entity) {
  if ($entity instanceOf ContentEntityInterface && Mcapi::maxWalletsOfBundle($entity->getEntityTypeId(), $entity->bundle())==1) {
    //get the entity's one wallet, and rename it.
    if ($wids = Mcapi::walletsOf($entity)) {
      $wallet = Wallet::load(reset($wids))->setHolder($entity)->save();
    }
  }
}

/**
 * implements hook_entity_insert()
 * give a new wallet to new entities, if the settings require
 */
function mcapi_entity_insert($entity) {
  $config = \Drupal::config('mcapi.settings');
  //note that intertrading wallets are created not here but in Exchange::postSave
  if ($config->get('autoadd')) {
    $type = $entity->getEntityTypeId();
    //NB autoadd applies to ALL entity types or to none
    if (Mcapi::maxWalletsOfBundle($type, $entity->bundle())) {
      //no need to check what the max is, since this is the first wallet created for this entity
      Wallet::create([
        'holder' => $entity,
        'name' => t('Default'),
      ])->save();
      \Drupal::logger('mcapi')->notice(
        'Wallet autocreated for new @entitytype @id',
        ['@entitytype' => $type, '@id' => $entity->id()]
      );
    }
  }
}


/**
 * implements hook_entity_predelete().
 *
 * orphan any wallets owned by the deleted entity.
 */
function mcapi_entity_predelete($entity) {
  if (Mcapi::maxWalletsOfBundle($entity->getEntityTypeId(), $entity->bundle())) {
    Wallet::orphan($entity);
  }
}

/**
 * implements hook_module_implements_alter().
 *
 * Ensures that mcapi_local_tasks_alter runs after field_ui_local_tasks_alter
 */
function mcapi_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'local_tasks_alter') {
    $group = $implementations ['mcapi'];
    unset($implementations ['mcapi']);
    $implementations ['mcapi'] = $group;
  }
}

/**
 * implements hook_local_tasks_alter().
 *
 * prevent the three fixed transaction display modes from being edited
 * Remove any unneeded wallet tabs
 */
function mcapi_local_tasks_alter(&$tasks) {
  foreach (['default', 'certificate', 'twig', 'sentence'] as $mode) {
    //unset($tasks["field_ui.fields:field_display_{$mode}_mcapi_transaction"]);
  }
  //remove the parent tab as well.
  //unset($tasks['field_ui.fields:display_overview_mcapi_transaction']);

  $settings = \Drupal::config('mcapi_settings');
  if (!$settings->get('wallet_inex_tab')) {
    unset($tasks['views_view:view.income_expenditure.income_page']);
  }
  if (!$settings->get('wallet_log_tab')) {
    unset($tasks['views_view:view.wallet_log.page']);
  }
}


/**
 * implements hook_entity_type_alter().
 * @param \Drupal\Core\Entity\EntityTypeInterface[] $entity_types
 * Change the action list controller to a wrapper which hides this modules operation actions
 */
function mcapi_entity_type_alter(array &$entity_types) {
  $entity_types['action']
    ->setListBuilderClass('Drupal\mcapi\Controller\ActionListOverride')
    ->setFormClass('mcapiedit', 'Drupal\mcapi\Form\TransactionActionEditForm');
}

/**
 * implements hook_entity_operation_alter().
 * prevent the transaction view modes from being tampered with
 */
function mcapi_entity_operation_alter(&$operations, $entity) {
  if (in_array('mcapi_transaction.'.$entity->id(), ['certificate', 'twig', 'sentence'])) {
    $operations = [];
  }
}

/*
 * implements hook_form_field_config_edit_form_alter().
 */
function mcapi_form_field_config_edit_form_alter(&$form, &$form_state) {
  if ($form_state->getFormObject()->getEntity()->getEntityTypeId() == 'mcapi_transaction') {
    //@see Drupal\mcapi\Form\CurrencyForm::save
    unset($form['required']);
  }
}

/**
 * implements hook_entity_extra_field_info().
 */
function mcapi_entity_extra_field_info() {
  //go through all the bundles which are configured to hold wallets
  $types = \Drupal::config('mcapi.settings')->get('entity_types');
  foreach((array)$types as $entity_bundle => $max) {
    //if (!$max) continue; //don't show wallets on bundles with maximum of 0 wallets
    list($entity_type, $bundle) = explode(':', $entity_bundle);
    $extra[$entity_type] = [
      $bundle => [
        'display' => [
          'wallets_summaries' => [
            'label' => \Drupal::translation()->formatPlural($max, 'Wallet summary', 'Wallets summaries'),
            'description' => t("The 'summary' view of all the entity's wallets."), //' '.l('admin/accounting/wallets/fields', Url::fromUri('admin/accounting/wallets/fields'),
            'weight' => 5,
          ],
        ]
      ]
    ];
  }

  $extra['mcapi_wallet']['mcapi_wallet']['display'] = [
    'stats' => [
      'label' => t('Trading stats'),
      'description' => t('Grid showing trading stats for all currencies'),
      'weight' => 5
    ],
    'balances' => [
      'label' => t('Balance'),
      'description' => t('Small thingy showing balances of all currencies'),
      'weight' => 6
    ],
    'histories' => [
      'label' => t('History chart'),
      'description' => t('One line chart per currency showing balance over time.'),
      'weight' => 7
    ],
    'balance_bars' => [
      'label' => t('Given & gotten'),
      'description' => t('One barchart per currency showing incoming and outgoing volumes'),
      'weight' => 8
    ],
    'canonical_link' => [
      'label' => t("Link to canonical view"),
      'description' => t("Link to canonical view"),
      'weight' => 11
    ]
  ];
  if (\Drupal::service('router.route_provider')->getRoutesByNames(['view.wallet_log.page'])) {
    $extra['mcapi_wallet']['mcapi_wallet']['display']['wallet_log'] = [
      'label' => t('Transaction_log (view)'),
      'description' => t('List of transactions (view)'),
      'weight' => 9
    ];
  }
  else drupal_set_message('Route view.wallet_log.page expected not found');

  if (\Drupal::service('router.route_provider')->getRoutesByNames(['view.income_expenditure.income_page'])) {
    $extra['mcapi_wallet']['mcapi_wallet']['display']['income_expenditure'] = [
      'label' => t('Income & expenditure (view)'),
      'description' => t('Two tables showing transactions in either direction'),
      'weight' => 10
    ];
  }
  else drupal_set_message('Route view.income_expenditure.income_page not found');


  return $extra;
}

/**
 * implements hook_theme().
 */
function mcapi_theme() {
  $file = ['file' => 'templates/theme.inc'];
  $items['worths'] = [
    'variables' => [
      'values' => [],
      'separator' => ''
    ]
  ] + $file;
  $items['worth'] = [
    'render element' => 'worth'
  ] + $file;
  $items['mcapi_transaction'] = [
    'render element' => 'transaction',
    'template' => 'transaction'
  ] + $file;
  //the above is the theme wrapper for the below
  //so they both take the same render_element
  $items['certificate'] = [
    'render element' => 'transaction',
    'template' => 'certificate',
    'pattern' => 'certificate__'
  ] + $file;
  $items['sentence'] = [
    'render element' => 'transaction'
  ] + $file;
  $items['mcapi_currency'] = [
    'render element' => 'currency',
    'template' => 'currency'
  ] + $file;
  $items['wallet_histories'] = [
    'render element' => 'element',
    'file' => 'src/History.php'
  ];
  $wallet_callbacks = [
    'mcapi_wallet',
    'mcapi_wallet_component',
    'wallet_balances',
    'wallet_balance_bars',
    'wallet_stats',
  ];
  foreach ($wallet_callbacks as $callback) {
    $items[$callback] = [
      'render element' => 'element',
    ] + $file;
  }
  return $items;
}

/**
 * take a worth value, typically from config and return true if all the
 *  currencies in it are zero
 * @param array $worth
 *   a worth value expressed as an array of arrays with curr_id & value
 * @return boolean
 *   TRUE if all the items have a worth of zero
 */
function empty_worth(array $worth) {
  foreach ($worth as $item) {
    if ($item['value']) {
      return FALSE;
    }
  }
  return TRUE;
}

/**
 * implement mcapi hook_mcapi_form_list().
 * return a list of transaction forms declared in this module.
 * each item must e an array with the following keys
 * - 'title' => 'Blah'
 * - 'route' => 'mcapi.transaction_form'
 * - 'route_parameters' => []
 * - 'operations' => [Url::fromPath('blah')] an array of items, each with title and path
 */
function mcapi_mcapi_form_list() {
  $forms['default'] = [
    'title' => t('Default'),
    'route' => 'mcapi.transaction.add',
    'route_parameters' => [],
    'operations' => []
  ];
  $forms['12many'] = [
    'title' => t('One wallet pays many'),
    'route' => 'mcapi.masspay.12many',
    'route_parameters' => [],
    'operations' => []
  ];
  $forms['many21'] = [
    'title' => t('Many wallets pay one'),
    'route' => 'mcapi.masspay.many21',
    'route_parameters' => [],
    'operations' => []
  ];
  return $forms;
}

function mcapi_entity_query_transaction_query_alter($query)  {
  drupal_set_message('mcapi_entity_query_transaction_query_alter chance to do some transaction access control');
}

/**
 * implements hook_entity_form_display_alter().
 * Ensure on startup that the worth field is visible in the entity form
 * this is nasty but there was no other way
 */
function mcapi_entity_form_display_alter($display, $display_context){
  if ($display_context['bundle'] == 'mcapi_transaction') {
    $display->setComponent('worth', ['type' =>'worth']);
  }
}
function mcapi_entity_view_display_alter($display, $display_context){
  if ($display_context['bundle'] == 'mcapi_transaction') {
    $display->setComponent('worth', ['type' =>'worth']);
  }
}