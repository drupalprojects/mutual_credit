<?php
// $Id:

//retrieves the max and min limits from the mcapi_cache table
//putting the balance in produces a different array with spending and earning capacity - both numbers positive.
function limits_get($currcode, $uid){
  module_load_include('inc', 'mcapi_limits');
  $currency = currency_load($currcode);
  if (isset($currency->limits['limits_callback']) && function_exists($currency->limits['limits_callback'])) {
    $callback = $currency->limits['limits_callback'];
    return $callback($currency, $uid);
  }
  drupal_set_message(t('Currency @curr_name has an illegal callback set to determine transaction limits: @callback', array(
    '@curr_name' => $currency->name,
    '@callback' => $currency->limits['limits_callback']
  )));
}
function limits_get_adjusted($currcode, $uid, $balance) {
  $limits = limits_get($currcode, $uid);
  return array(
    'spend_limit' => $limits['max'] - $balance,
    'earn_limit' => abs($limits['min'] - $balance)
  );
}
/*
 * implements hook_form_FORM_ID_alter
 * if we know the direction of the transaction we can use the worth field #max property to set the limit
 * otherwise use this function as a callback
 * NB this is form level validation not field level
 * that means transaction_first_form_validate() has run and built the transaction object, and it is in the db with an xid
 * 
 * Note that the worth_field widget has a validator for the max allowed value,
 * But unless you know the payer and/payee when you are building the form, it's not so useful.
 */
function mcapi_limits_form_transaction_form_alter(&$form, &$form_state) {
  $form['#validate'][] = 'limits_form_validate';
}
/*
 * implements element validate callback injected into transaction form
 * I didn't want to generate error messages by this module, at the point of checking, but throw an error and deliver the error message at the form processing level
 * Because i don't know how to pass args into an exception, the limit checker throws coded exceptions, not straight messages
 * if a transaction fails becuase the payee would exceed the max limit, it throws
 * new exception($difference, '>', $limit)
 * and vice versa
 */
function limits_form_validate(&$form, &$form_state) {
  if (count(form_get_errors())) return;
  $transaction = &$form_state['transaction'];
  try {
    mcapi_limit_check(
      $transaction->payer,
      $transaction->payee,
      current($transaction->worth),
      //if the transaction is finished and hence this is an edit operation, the check function
      //needs to discount it
      $transaction->state < 1 ? NULL : current(transaction_load($transaction->xid)->worth)
    );
  }
  catch (Exception $e) {
    $message = $e->getMessage();
    //parse balance limits error
    if (module_exists('mcapi_limits')) {
      if (strpos($message, '>')) {
        list($excess, $limit, $currcode) = explode('>', $message);
        $message = t('Transaction would take @username !quant above the maximum balance of !max',
          array(
            '@username' => strip_tags(format_username(user_load($transaction->payee))),
            '!quant' => theme('worth_field', array('quantity' => $excess, 'currcode' => $currcode)),
            '!max' => theme('worth_field', array('quantity' => $limit, 'currcode' => $currcode))
          )
        );
      }
      elseif (strpos($message, '<')) {
        list($excess, $limit, $currcode) = explode('<', $message);
        $message = t('Transaction would take @username !quant below the minimum balance of !min',
          array(
            '@username' => strip_tags(format_username(user_load($transaction->payer))),
            '!quant' => theme('worth_field', array('currcode' => $currcode, 'quantity' => $excess)),
            '!min' => theme('worth_field', array('quantity' => $limit, 'currcode' => $currcode)),
          )
        );
      }
    }
    form_error($form['worth'], $message);
  }
}

/*
 * limit checker
 * checks a transaction (during validation) to see if it pushes either party beyond their balance limits
 * Payer = user uid
 * payee = user uid
 * $flows = 'und' value of worth field
 * the transaction being edited NOT being created
 * This might have been done through the entity controller if the balances were in the database,
 * but in this module balances are calculated on the fly
 */
function mcapi_limit_check($payer_uid, $payee_uid, $flows, $adjust_flows = 0) {
  foreach ($flows as $delta => $flow) {
    $currcode = $flow['currcode'];
    $difference = $flow['quantity'] - $adjust_flows[$delta]['quantity'];
    //check that the payee isn't going over their max limit
    $limits = limits_get($currcode, $payee_uid);
    if (is_numeric($limits['max'])) {
      $totals = transaction_totals($payee_uid, $currcode);
      $payee_projected = $totals['balance'] + $difference;
      $surplus = $payee_projected - $limits['max'];
      if ($surplus > 0) {
        throw new Exception($surplus .'>'.$limits['max']. '>' .$currcode);
      }
    }
    //check that the payer isn't going below their min limit
    $limits = limits_get($currcode, $payer_uid);
    if (is_numeric($limits['min'])) {
      $totals = transaction_totals($payer_uid, $currcode);
      $payer_projected = $totals['balance'] - $difference;
      $deficit = $limits['min'] - $payer_projected;
      if ($deficit > 0) {
        throw new Exception($deficit .'<'.$limits['min']. '<' .$currcode);
      }
    }
  }
}

/*
 * implements hook_currency_form_alter
 */
function mcapi_limits_currency_innerform_alter(&$form, &$form_state) {
  if (!isset($form['#currency'])) return;
  form_load_include($form_state, 'inc', 'mcapi_limits');
  $limits_callback = isset($form['#currency']->limits['limits_callback']) ? $form['#currency']->limits['limits_callback'] : 'limits_none';
  //limits could be managed by drupal OR the entity controller. Drupal offers more flexibility
  $form['limits'] = array(
    '#title' => t('Balance limits'),
    '#description' => t('Transactions will be rejected which take accounts beyond these limits.') .' '. t('Choose which method to use, and configure it.'),
    '#type' => 'fieldset',
    '#weight' => 20,
    '#group' => 'additional_settings',
    '#collapsible' => TRUE,
    '#collapsed' => isset($form['#currency']->limits_callback),
    //'#group' => 'additional_settings',
    'limits_callback' => array(
      '#title' => t('Method'),
      '#description' => t('How will the limits be determined?'),
      '#type' => 'select',
      '#options' => array(
        'limits_none' => t('No limits'),
        'limits_global' => t('Everyone has the same limits, stated below'),
        'limits_personal' => t('Fields on the user profile can override limits stated below.'),
        'limits_equations' => t('Calculate the limits using an equation and tokens.'),
      ),
      '#default_value' => isset($form_state['values']['limits_callback']) ?
        $form_state['values']['limits_callback'] :
        $limits_callback,
      '#weight' => -1,
      '#ajax' => array(
        'callback' => 'limits_settings_subform',
        'wrapper' => 'limits-settings',
      )
    )
  );
  limits_settings_subform($form, $form_state);
  //we are relying in the inserted fields to validate themselves individually, so there is no validation added at the form level
}


//put the fields on the user form
function mcapi_limits_form_user_profile_form_alter(&$form, &$form_state) {
  if (!user_access('manage all transactions')) return;
  module_load_include('inc', 'mcapi_limits');
  //get all the currencies with personal limits, so as to display config fields on the user profile form
  $currencies = currencies_load($form['#user']);
  foreach ($currencies as $currcode => $currency) {
    if (isset($currency->limits['limits_personal'])){
      $form['limits_personal'][$currcode] = array(
         '#type' => 'fieldset',
         '#title' => $currency->name,
         '#attributes' => array('style' => 'float:left;')
      );
      $fields = min_max_fields(limits_get($currcode, $form['#user']->uid));
      $form['limits_personal'][$currcode]['min-'.$currcode] = $fields['min'];
      $form['limits_personal'][$currcode]['max-'.$currcode] = $fields['max'];
      //by creating this key, we enable the values to be saved. See user_profile_form_submit in modules/user/user.pages.inc
      $form_state['user']->limits_personal = TRUE;
    }
  }
  //add a containing fieldset if needed
  if (isset($form['limits_personal'])) {
    $form['limits_personal'] += array(
      '#title' => t('Personal balance limits, set manually'),
      '#type' => 'fieldset',
      '#weight' => 2
    );
  }
}
/*
 * implements hook_user_presave
 */
function mcapi_limits_user_presave(&$edit, $account, $category) {
  if ($category != 'account') return;
  $currencies = currencies_load($account->uid);
  foreach($currencies as $currcode => $currency) {
    if (isset($currency->limits['limits_callback']) && $currency->limits['limits_callback'] == 'limits_personal') {
      if (isset($edit['min-'.$currcode])) {
        $edit['data']['limits_personal'][$currcode]['min'] = $edit['min-'.$currcode];
      }
      if (isset($edit['max-'.$currcode])) {
        $edit['data']['limits_personal'][$currcode]['max'] = $edit['max-'.$currcode];
      }
    }
  }
}


/*
 * Implements views hook_views_api
 */
function mcapi_limits_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'mcapi_limits').'/views',
  );
}


/*
 * Implements hook_theme
 */
function mcapi_limits_theme($existing, $type, $theme, $path){
  //the block names are the same as the theme callbacks
  return array(
    //similar to balance limits, but only shows one currency
    'balance_limits' => array(
      'template' => 'balance_limits',
      'variables' => array(
        'currency' => '',
        'min' => 0,
        'balance' => 0,
        'max' => 0
      )
    ),
    'trading_limits' => array(
      'template' => 'balance_limits',
      'variables' => array(
        'currency' => '',
        'min' => 0,
        'balance' => 0,
        'max' => 0
      )
    )
  );
}

/*
 * Implements views hook_block_list
 */
function mcapi_limits_block_info() {
  //the block names are the same as the theme callbacks
  $blocks['balance_limits'] = array(
    'info' => 'MC '. t("Balance limits")
  );
  $blocks['trading_limits'] = array(
    'info' => 'MC '. t("Trading limits (adjusted for the balance)")
  );
  return $blocks;
}

/*
 * Implements views hook_block_view
 */
function mcapi_limits_block_view($delta) {
  $account = arg(0) == 'user' ? user_uid_optional_load(arg(1)) : $GLOBALS['user'];

  if (!user_access('view all balances') && !$account->uid == $GLOBALS['user']->uid) return;
  //module_load_include('admin.inc', 'mcapi', 'currencies');
  module_load_include('inc', 'mcapi_limits');
  $settings = mcapi_limits_block_settings('block_'.$delta);
  if (empty($settings['currcodes'])) {
    $settings['currcodes'] = array_keys(currencies_load());
  }
  $function = 'show_'.$delta;
  foreach ($settings['currcodes'] as $currcode) {
    $output[] = $function($account, $currcode);
  }
  return array(
    'subject' => t("@user's limits", array('@user' => strip_tags(format_username($account)))),
    'content' => $output
  );
}


/*
 * Implements views hook_block_configure
 */
function mcapi_limits_block_configure($delta) {
  $settings = mcapi_limits_block_settings('block_'.$delta);
  if (module_exists('mcapi_currencies')) {
    $form['currcodes'] = currency_picker_element($settings['currcodes'], TRUE);
  }
  $form['adjust'] = array(
    '#title' => t('Take account of balance'),
    '#description' => t('add the balance to the limits, showing the available limits'),
    '#type' => 'checkbox',
    '#default_value' => $settings['adjust']
  );
  return $form;
}

/*
 * Implements views hook_block_save
 */
function mcapi_limits_block_save($delta, $values) {
  variable_set(
    'block_'. $delta,
    array(
      'currcodes' => $values['currcodes'],
      'adjust' => $values['adjust']
    )
  );
}
function mcapi_limits_block_settings($delta) {
  $settings = variable_get($delta, array());
  return $settings ? $settings : array('currcodes' => array_keys(currencies_load()), 'adjust' => FALSE);
}


/*
 * Implements variable module's hook_variable_info
 * only block settings really
 */
function mcapi_limits_variable_info() {
  foreach (mcapi_limits_block_info() as $varname -> $info) {
    $vars[$varname] = array(
      'type' => 'array',
      'title' => $info['info'],
      'default' => array(),
      'description' => t('Block settings'),
      'required' => FALSE,
    );
  }
  return $vars;
}
